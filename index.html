<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Workout Tracker + Rest Timer</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0f17">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    html { -webkit-text-size-adjust: 100%; }
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0f17; color:#e8eefc; }

    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; padding-bottom: 160px; }
    h1 { font-size: 20px; margin: 0 0 12px; }

    .card { background:#121a2a; border: 1px solid #24314f; border-radius: 18px; padding: 14px; }
    .divider { height: 1px; background:#24314f; margin: 14px 0; }
    .muted { font-size: 13px; opacity: .75; line-height: 1.35; }

    label { display:block; font-size:13px; opacity:.85; margin-bottom: 6px; }
    input, select, textarea, button {
      width:100%;
      box-sizing:border-box;
      background:#0e1422;
      color:#e8eefc;
      border:1px solid #2a3a60;
      border-radius:14px;
      padding:14px;
      font-size:16px;
      min-height:52px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus { border-color:#5c7dff; }
    textarea { min-height: 92px; resize: vertical; }
    button { cursor:pointer; font-weight: 900; }

    /* iOS date input styling */
    input[type="date"]{ appearance:none; -webkit-appearance:none; text-align:center; }
    input[type="date"]::-webkit-date-and-time-value{ text-align:center; }

    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > div { flex:1; min-width: 160px; }

    .actions { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    /* Pages */
    .page { display:none; }
    .page.active { display:block; }

    /* Tabs */
    .tabbar{
      position:fixed;
      left:0; right:0; bottom:0;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:8px;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(11,15,23,.95);
      border-top:1px solid #24314f;
      backdrop-filter: blur(10px);
    }
    .tabbar button.active { border-color:#5c7dff; }

    /* Exercises */
    .exercise {
      border:1px solid #24314f;
      border-radius:16px;
      padding:12px;
      margin-top:12px;
      background:#0e1422;
    }
    .exercise-header { display:flex; gap:10px; align-items:center; }
    .exercise-header input { flex:1; min-width: 0; }
    .iconBtn { width:56px; min-width:56px; padding:0; font-size:18px; }

    .lastBox {
      margin-top: 10px;
      padding: 10px;
      border: 1px dashed #2a3a60;
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
    }
    .lastBox strong { display:block; margin-bottom:4px; font-size:13px; }

    .sets { margin-top:10px; display:grid; gap:10px; }
    .setRow { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .setRow input { flex:1; min-width:120px; }
    .setRow button { width:56px; min-width:56px; padding:0; }

    /* Timer */
    .pillrow { display:flex; gap:10px; flex-wrap:wrap; }
    .pillrow button { width:auto; border-radius:999px; padding:12px 16px; min-height:48px; }
    .timerBig { text-align:center; font-size:52px; font-weight:1000; margin: 14px 0; }

    /* History cards */
    .entry { border:1px solid #24314f; border-radius:16px; padding:12px; background:#0e1422; margin-top:10px; }
    .entryTop { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .entryTitle { font-weight: 950; }
    .entryMeta { font-size:12px; opacity:.8; }

    .danger { border-color:#ff5c7a !important; }

    /* Graph */
    canvas { width:100%; height:220px; background:#0e1422; border:1px solid #24314f; border-radius:16px; }
    .graphRow { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    .graphRow > div { flex:1; min-width: 200px; }

    /* Flash overlay */
    .flash {
      position:fixed; inset:0;
      background:rgba(92,125,255,.2);
      opacity:0; pointer-events:none;
      transition: opacity 160ms;
    }
    .flash.on { opacity:1; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Workout Tracker + Rest Timer</h1>

    <!-- PAGE: LOG -->
    <section id="page-log" class="page active">
      <div class="card">

        <div class="row">
          <div>
            <label>Template</label>
            <select id="template">
              <option value="">(None)</option>
              <option value="push">Push</option>
              <option value="pull">Pull</option>
              <option value="legs">Legs</option>
            </select>
            <div class="muted" style="margin-top:6px;">Pick a template then tap “Load Template”.</div>
          </div>
          <div style="display:flex; align-items:end;">
            <button id="loadTemplateBtn">Load Template</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Week # (auto from date)</label>
            <input id="week" type="number" min="1" placeholder="Auto" />
            <div class="muted" style="margin-top:6px;">Uses ISO week-of-year. You can still override it.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Day of week</label>
            <select id="day">
              <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
              <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
            </select>
          </div>
          <div>
            <label>Date</label>
            <input id="date" type="date" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="actions">
          <button id="addExerciseBtn">+ Add Exercise</button>
          <button id="saveBtn">Save Workout</button>
        </div>

        <div id="exerciseList"></div>

        <div class="divider"></div>

        <label>Notes (optional)</label>
        <textarea id="notes" rows="3" placeholder="How it felt, PRs, etc."></textarea>

      </div>
    </section>

    <!-- PAGE: TIMER -->
    <section id="page-timer" class="page">
      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px;">Rest Timer</h2>

        <div class="pillrow">
          <button class="preset" data-sec="60">60s</button>
          <button class="preset" data-sec="90">90s</button>
          <button class="preset" data-sec="120">120s</button>
          <button class="preset" data-sec="180">180s</button>
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <label>Custom seconds</label>
            <input id="customSec" type="number" min="5" step="5" placeholder="e.g., 75" />
          </div>
          <div style="display:flex; align-items:end;">
            <button id="setCustomBtn">Set</button>
          </div>
        </div>

        <div class="timerBig" id="timerDisplay">01:30</div>

        <div class="actions">
          <button id="startPauseBtn">Start</button>
          <button id="resetBtn">Reset</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          Tip: At 0 you’ll get beep + flash + a vibration pattern (if supported).
        </div>
      </div>
    </section>

    <!-- PAGE: HISTORY -->
    <section id="page-history" class="page">
      <div class="card">
        <div class="row">
          <div>
            <label>Search history</label>
            <input id="search" placeholder="e.g., bench, week 3, monday" />
          </div>
          <div style="display:flex; align-items:end;">
            <button id="clearAllBtn" class="danger">Clear All</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="graphRow">
          <div>
            <label>Graph exercise</label>
            <select id="graphExercise"></select>
            <div class="muted" style="margin-top:6px;">Shows progress over time for the selected metric.</div>
          </div>
          <div>
            <label>Metric</label>
            <select id="graphMetric">
              <option value="maxWeight">Max Weight</option>
              <option value="volume">Total Volume (reps×weight)</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px;">
          <canvas id="chart" width="900" height="220"></canvas>
        </div>

        <div class="divider"></div>

        <div class="muted">Workout History</div>
        <div id="history"></div>
      </div>
    </section>
  </div>

  <!-- Tabs -->
  <div class="tabbar">
    <button class="active" data-page="log">Log</button>
    <button data-page="timer">Timer</button>
    <button data-page="history">History</button>
  </div>

  <div class="flash" id="flash"></div>

<script>
  // ====== SETTINGS ======
  const STORAGE_KEY = "workouts_v2";
  const DEFAULT_REST_SECONDS = 90;  // <— change this anytime (e.g., 60/120)

  // ---------- Storage ----------
  function getWorkouts() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch { return []; }
  }
  function setWorkouts(list) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  // ---------- ISO week ----------
  function isoWeekNumber(dateObj) {
    const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }
  function defaultDayFromDate(d) {
    const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    return days[d.getDay()];
  }

  // ---------- DOM ----------
  const weekEl = document.getElementById("week");
  const dayEl = document.getElementById("day");
  const dateEl = document.getElementById("date");
  const notesEl = document.getElementById("notes");
  const exerciseListEl = document.getElementById("exerciseList");
  const historyEl = document.getElementById("history");
  const searchEl = document.getElementById("search");
  const flashEl = document.getElementById("flash");

  const templateEl = document.getElementById("template");
  const loadTemplateBtn = document.getElementById("loadTemplateBtn");

  const graphExerciseEl = document.getElementById("graphExercise");
  const graphMetricEl = document.getElementById("graphMetric");
  const chartEl = document.getElementById("chart");
  const ctx = chartEl.getContext("2d");

  // ---------- Pages / Tabs ----------
  const pages = document.querySelectorAll(".page");
  const tabs = document.querySelectorAll(".tabbar button");

  function showPage(name){
    tabs.forEach(b => b.classList.toggle("active", b.dataset.page === name));
    pages.forEach(p => p.classList.toggle("active", p.id === "page-" + name));

    if (name === "history") {
      loadHistory();
      refreshGraphSelectors();
      drawGraph();
    }
  }
  tabs.forEach(btn => btn.addEventListener("click", () => showPage(btn.dataset.page)));

  // ---------- Templates ----------
  const TEMPLATES = {
    push: ["Bench Press", "Incline DB Press", "Overhead Press", "Lateral Raises", "Triceps Pushdown"],
    pull: ["Pull-ups / Lat Pulldown", "Barbell Row", "Seated Cable Row", "Face Pull", "Biceps Curl"],
    legs: ["Squat", "Leg Press", "Romanian Deadlift", "Leg Curl", "Calf Raise"]
  };

  // ---------- Previous workout lookup ----------
  function normalizeName(s) { return (s || "").trim().toLowerCase(); }

  function findLastExerciseEntry(exName) {
    const name = normalizeName(exName);
    if (!name) return null;
    const all = getWorkouts();
    for (const w of all) {
      for (const ex of (w.exercises || [])) {
        if (normalizeName(ex.name) === name) return { workout: w, exercise: ex };
      }
    }
    return null;
  }

  function formatExerciseLine(ex) {
    const sets = (ex.sets || [])
      .filter(s => String(s.reps).trim() || String(s.weight).trim())
      .map(s => `${s.reps || "?"} reps @ ${s.weight || "?"}`)
      .join(" • ");
    return sets || "(no sets saved)";
  }

  // ---------- Exercises UI ----------
  let exercises = [];

  function addExercise(name="") {
    exercises.push({ name, sets: [] });
    renderExercises();
  }

  function addSet(i) {
    exercises[i].sets.push({ reps: "", weight: "" });
    renderExercises();
  }

  function removeExercise(i) {
    exercises.splice(i, 1);
    renderExercises();
  }

  function renderExercises() {
    exerciseListEl.innerHTML = "";
    exercises.forEach((ex, i) => {
      const last = findLastExerciseEntry(ex.name);

      const wrap = document.createElement("div");
      wrap.className = "exercise";

      const lastHtml = last ? `
        <div class="lastBox">
          <strong>Last time (${last.workout.date || "no date"} • Week ${last.workout.week || "?"} • ${last.workout.day || ""})</strong>
          <div class="muted">${formatExerciseLine(last.exercise)}</div>
        </div>
      ` : `
        <div class="lastBox">
          <strong>Last time</strong>
          <div class="muted">Type an exercise name to show your previous sets.</div>
        </div>
      `;

      wrap.innerHTML = `
        <div class="exercise-header">
          <input class="exName" placeholder="Exercise name" value="${(ex.name||"").replace(/"/g,'&quot;')}" />
          <button class="iconBtn" title="Remove exercise">✕</button>
        </div>

        ${lastHtml}

        <div class="sets">
          ${(ex.sets || []).map((s, j) => `
            <div class="setRow">
              <input class="repIn" inputmode="numeric" placeholder="Reps" value="${String(s.reps||"").replace(/"/g,'&quot;')}" data-i="${i}" data-j="${j}">
              <input class="wtIn" inputmode="decimal" placeholder="Weight" value="${String(s.weight||"").replace(/"/g,'&quot;')}" data-i="${i}" data-j="${j}">
              <button class="iconBtn rmSet" title="Remove set" data-i="${i}" data-j="${j}">−</button>
            </div>
          `).join("")}
        </div>

        <button class="addSetBtn" style="margin-top:10px;" data-i="${i}">+ Add Set</button>
      `;

      wrap.querySelector("button[title='Remove exercise']").addEventListener("click", () => removeExercise(i));
      wrap.querySelector(".addSetBtn").addEventListener("click", () => addSet(i));

      wrap.querySelector(".exName").addEventListener("input", (e) => {
        exercises[i].name = e.target.value;
        renderExercises(); // refresh last-time box
      });

      wrap.querySelectorAll(".repIn").forEach(inp => {
        inp.addEventListener("input", (e) => {
          const ii = Number(e.target.dataset.i);
          const jj = Number(e.target.dataset.j);
          exercises[ii].sets[jj].reps = e.target.value;
        });
      });

      wrap.querySelectorAll(".wtIn").forEach(inp => {
        inp.addEventListener("input", (e) => {
          const ii = Number(e.target.dataset.i);
          const jj = Number(e.target.dataset.j);
          exercises[ii].sets[jj].weight = e.target.value;
        });
      });

      wrap.querySelectorAll(".rmSet").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const ii = Number(e.target.dataset.i);
          const jj = Number(e.target.dataset.j);
          exercises[ii].sets.splice(jj, 1);
          renderExercises();
        });
      });

      exerciseListEl.appendChild(wrap);
    });
  }

  // ---------- Timer ----------
  let remaining = DEFAULT_REST_SECONDS;
  let timerId = null;
  let running = false;

  const timerDisplay = document.getElementById("timerDisplay");
  const startPauseBtn = document.getElementById("startPauseBtn");
  const resetBtn = document.getElementById("resetBtn");
  const setCustomBtn = document.getElementById("setCustomBtn");
  const customSec = document.getElementById("customSec");

  function updateTimer() {
    const m = String(Math.floor(remaining / 60)).padStart(2,"0");
    const s = String(remaining % 60).padStart(2,"0");
    timerDisplay.textContent = `${m}:${s}`;
  }

  function beep() {
    try {
      const ctxA = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctxA.createOscillator();
      const g = ctxA.createGain();
      o.type = "sine";
      o.frequency.value = 880;
      o.connect(g);
      g.connect(ctxA.destination);
      g.gain.value = 0.12;
      o.start();
      setTimeout(() => { o.stop(); ctxA.close(); }, 250);
    } catch {}
  }

  function flash() {
    flashEl.classList.add("on");
    setTimeout(() => flashEl.classList.remove("on"), 260);
  }

  // Apple Watch-ish vibration pattern (if supported; iPhone often blocks this)
  function watchVibrate() {
    if (!navigator.vibrate) return;
    navigator.vibrate([70, 40, 70, 40, 140, 70, 140]);
  }

  function setTimer(sec) {
    remaining = sec;
    updateTimer();
  }

  function stopTimerIfRunning() {
    if (running) {
      clearInterval(timerId);
      running = false;
      startPauseBtn.textContent = "Start";
    }
  }

  function startTimer() {
    if (running) return;
    running = true;
    startPauseBtn.textContent = "Pause";
    timerId = setInterval(() => {
      if (remaining <= 0) {
        clearInterval(timerId);
        running = false;
        startPauseBtn.textContent = "Start";
        beep(); flash(); watchVibrate();
      } else {
        remaining--;
        updateTimer();
      }
    }, 1000);
  }

  function startPause() {
    if (running) {
      clearInterval(timerId);
      running = false;
      startPauseBtn.textContent = "Start";
      return;
    }
    startTimer();
  }

  function resetTimer() {
    stopTimerIfRunning();
    setTimer(DEFAULT_REST_SECONDS);
  }

  // ✅ Save → switch to timer → set + start
  function startRestFlow() {
    showPage("timer");
    stopTimerIfRunning();
    setTimer(DEFAULT_REST_SECONDS);
    startTimer();
  }

  // ---------- Save workout ----------
  function saveWorkout() {
    const date = String(dateEl.value || "").trim();
    if (!date) { alert("Please select a date."); return; }

    if (!String(weekEl.value || "").trim()) {
      try { weekEl.value = isoWeekNumber(new Date(date)); } catch {}
    }

    const payload = {
      week: Number(weekEl.value),
      day: dayEl.value,
      date: dateEl.value,
      notes: notesEl.value,
      exercises: exercises.map(e => ({
        name: (e.name || "").trim(),
        sets: (e.sets || []).map(s => ({ reps: s.reps, weight: s.weight }))
      }))
    };

    const all = getWorkouts();
    all.unshift(payload);
    setWorkouts(all);

    // reset log screen
    exercises = [];
    notesEl.value = "";
    renderExercises();

    // Start rest automatically after save
    startRestFlow();
  }

  // ---------- History ----------
  function workoutMatchesSearch(w, q) {
    if (!q) return true;
    const hay = [
      `week ${w.week || ""}`,
      w.day || "",
      w.date || "",
      w.notes || "",
      ...(w.exercises || []).flatMap(ex => [
        ex.name || "",
        ...((ex.sets || []).map(s => `${s.reps} ${s.weight}`))
      ])
    ].join(" ").toLowerCase();
    return hay.includes(q);
  }

  function loadHistory() {
    const q = (searchEl.value || "").trim().toLowerCase();
    const list = getWorkouts().filter(w => workoutMatchesSearch(w, q));

    historyEl.innerHTML = "";
    list.slice(0, 50).forEach((w) => {
      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <div class="entryTop">
          <div class="entryTitle">Week ${w.week || "?"} • ${w.day || ""}</div>
          <div class="entryMeta">${w.date || ""}</div>
        </div>
        <div class="muted" style="margin-top:8px;">
          ${(w.exercises || []).map(ex => {
            const line = (ex.sets || []).map(s => `${s.reps || "?"}@${s.weight || "?"}`).join(", ");
            return `<div><strong>${(ex.name || "Unnamed")}</strong>: ${line || "(no sets)"}</div>`;
          }).join("")}
          ${w.notes ? `<div style="margin-top:8px;"><em>Notes:</em> ${String(w.notes).replace(/</g,"&lt;")}</div>` : ""}
        </div>
      `;
      historyEl.appendChild(div);
    });
  }

  // ---------- Graph ----------
  function getUniqueExercises() {
    const set = new Set();
    for (const w of getWorkouts()) {
      for (const ex of (w.exercises || [])) {
        const n = (ex.name || "").trim();
        if (n) set.add(n);
      }
    }
    return Array.from(set).sort((a,b)=>a.localeCompare(b));
  }

  function refreshGraphSelectors() {
    const names = getUniqueExercises();
    const current = graphExerciseEl.value;

    graphExerciseEl.innerHTML = "";
    if (names.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "(No data yet)";
      graphExerciseEl.appendChild(opt);
      return;
    }

    names.forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      graphExerciseEl.appendChild(opt);
    });

    if (current && names.includes(current)) graphExerciseEl.value = current;
  }

  function num(x) {
    const v = parseFloat(String(x).replace(/[^0-9.]/g,""));
    return Number.isFinite(v) ? v : 0;
  }

  function computeSeries(exName, metric) {
    const name = normalizeName(exName);
    const all = getWorkouts().slice().reverse(); // oldest -> newest
    const points = [];

    for (const w of all) {
      let val = null;
      for (const ex of (w.exercises || [])) {
        if (normalizeName(ex.name) !== name) continue;

        const sets = ex.sets || [];
        if (metric === "volume") {
          let vol = 0;
          sets.forEach(s => { vol += num(s.reps) * num(s.weight); });
          val = vol;
        } else {
          let mx = 0;
          sets.forEach(s => { mx = Math.max(mx, num(s.weight)); });
          val = mx;
        }
      }
      if (val !== null) points.push({ date: w.date || "", value: val });
    }
    return points;
  }

  function drawGraph() {
    ctx.clearRect(0,0,chartEl.width, chartEl.height);
    ctx.fillStyle = "#0e1422";
    ctx.fillRect(0,0,chartEl.width, chartEl.height);

    const exName = graphExerciseEl.value;
    const metric = graphMetricEl.value;

    const points = exName ? computeSeries(exName, metric) : [];
    if (points.length < 2) {
      ctx.fillStyle = "rgba(232,238,252,0.75)";
      ctx.font = "16px system-ui";
      ctx.fillText("Not enough data to draw a graph yet.", 18, 40);
      return;
    }

    const padL = 44, padR = 18, padT = 18, padB = 34;
    const W = chartEl.width - padL - padR;
    const H = chartEl.height - padT - padB;

    const vals = points.map(p=>p.value);
    const minV = Math.min(...vals);
    const maxV = Math.max(...vals);
    const span = (maxV - minV) || 1;

    // axes
    ctx.strokeStyle = "#24314f";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT + H);
    ctx.lineTo(padL + W, padT + H);
    ctx.stroke();

    // line
    ctx.strokeStyle = "#5c7dff";
    ctx.lineWidth = 3;
    ctx.beginPath();
    points.forEach((p, i) => {
      const x = padL + (i/(points.length-1))*W;
      const y = padT + H - ((p.value - minV)/span)*H;
      if (i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // dots
    ctx.fillStyle = "#e8eefc";
    points.forEach((p,i)=>{
      const x = padL + (i/(points.length-1))*W;
      const y = padT + H - ((p.value - minV)/span)*H;
      ctx.beginPath();
      ctx.arc(x,y,4,0,Math.PI*2);
      ctx.fill();
    });

    // labels
    ctx.fillStyle = "rgba(232,238,252,0.75)";
    ctx.font = "12px system-ui";
    ctx.fillText(String(maxV.toFixed(0)), 10, padT + 12);
    ctx.fillText(String(minV.toFixed(0)), 10, padT + H);
  }

  graphExerciseEl.addEventListener("change", drawGraph);
  graphMetricEl.addEventListener("change", drawGraph);

  // ---------- Wiring ----------
  document.getElementById("addExerciseBtn").addEventListener("click", () => addExercise());
  document.getElementById("saveBtn").addEventListener("click", saveWorkout);

  document.querySelectorAll(".preset").forEach(btn => {
    btn.addEventListener("click", () => setTimer(Number(btn.dataset.sec)));
  });

  setCustomBtn.addEventListener("click", () => {
    const v = Number(customSec.value);
    if (v && v >= 5) setTimer(v);
  });

  startPauseBtn.addEventListener("click", startPause);
  resetBtn.addEventListener("click", resetTimer);

  document.getElementById("clearAllBtn").addEventListener("click", () => {
    if (confirm("Delete all saved workouts?")) {
      localStorage.removeItem(STORAGE_KEY);
      loadHistory();
      refreshGraphSelectors();
      drawGraph();
    }
  });

  searchEl.addEventListener("input", loadHistory);

  // Template load
  loadTemplateBtn.addEventListener("click", () => {
    const key = templateEl.value;
    if (!key || !TEMPLATES[key]) return;
    exercises = TEMPLATES[key].map(n => ({ name: n, sets: [] }));
    renderExercises();
  });

  // Date -> auto week + day
  dateEl.addEventListener("change", () => {
    try { weekEl.value = isoWeekNumber(new Date(dateEl.value)); } catch {}
    dayEl.value = defaultDayFromDate(new Date(dateEl.value));
  });

  // ---------- Init ----------
  (function init() {
    // default date
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");
    dateEl.value = `${yyyy}-${mm}-${dd}`;

    weekEl.value = isoWeekNumber(today);
    dayEl.value = defaultDayFromDate(today);

    setTimer(DEFAULT_REST_SECONDS);
    loadHistory();
    refreshGraphSelectors();
    drawGraph();

    // offline support
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }
  })();
</script>
</body>
</html>
